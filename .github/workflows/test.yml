name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: session-start.sh — valid JSON with SessionStart event
        run: |
          output=$(echo '{}' | CLAUDE_PLUGIN_ROOT=. bash scripts/session-start.sh)
          echo "$output" | python3 -m json.tool > /dev/null
          echo "$output" | python3 -c "
import json, sys
d = json.load(sys.stdin)
assert d['hookSpecificOutput']['hookEventName'] == 'SessionStart', 'Missing SessionStart'
assert len(d['hookSpecificOutput']['additionalContext']) > 0, 'Empty additionalContext'
"
          echo "✅ session-start.sh output is valid"

      - name: session-start.sh — additionalContext contains router skill content
        run: |
          context=$(echo '{}' | CLAUDE_PLUGIN_ROOT=. bash scripts/session-start.sh | python3 -c "import json,sys; print(json.load(sys.stdin)['hookSpecificOutput']['additionalContext'])")
          echo "$context" | grep -q "EXTREMELY-IMPORTANT" || { echo "❌ Missing EXTREMELY-IMPORTANT in router skill"; exit 1; }
          echo "$context" | grep -q "autology" || { echo "❌ Missing autology skill content"; exit 1; }
          echo "✅ additionalContext contains router skill content"

      - name: session-end.sh — outputs tip as JSON systemMessage
        run: |
          output=$(echo '{}' | bash scripts/session-end.sh)
          echo "$output" | python3 -m json.tool > /dev/null
          echo "$output" | python3 -c "
import json, sys
d = json.load(sys.stdin)
assert 'autology' in d['systemMessage'].lower(), 'Missing autology in systemMessage'
"
          echo "✅ session-end.sh outputs tip as JSON systemMessage"
